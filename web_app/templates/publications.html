{% extends "base.html" %}

{% block title %}Publications Validator - Antigence‚Ñ¢{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="container mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active">Publications Validator</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-file-alt text-primary"></i> Publications Validator</h1>
            <p class="lead">Verify scientific claims using trained SciFact B Cell and NK Cell agents</p>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Powered by SciFact dataset trained models.
                Paste one or multiple scientific claims below for validation.
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Panel -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-keyboard"></i> Citation Input
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="citationsInput" class="form-label">Paste scientific claims (one per line):</label>
                        <textarea class="form-control" id="citationsInput" rows="15"
                            placeholder="Example claims:

Aspirin reduces the risk of heart attack.

Vitamin C prevents the common cold.

COVID-19 vaccines are effective at preventing severe disease.

(Enter one claim per line)"></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-lightbulb"></i> Tip: Each claim will be validated independently
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="validationMode" class="form-label">Validation Pipeline:</label>
                        <select class="form-select" id="validationMode">
                            <option value="quick">‚ö° Quick Scan (B Cell only) - Fast, lower accuracy</option>
                            <option value="standard" selected>üéØ Standard (B Cell + NK Cell) - Balanced</option>
                            <option value="enhanced">üî¨ Enhanced (B Cell + NK Cell + Dendritic) - Higher accuracy</option>
                            <option value="deep">üß† Deep Analysis (All Antigents + Memory) - Maximum precision</option>
                            <option value="orchestrated">üåê Orchestrated (LLM + Full Pipeline) - Highest accuracy, slower</option>
                        </select>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Each mode uses different antigent combinations, trading speed for accuracy
                        </small>
                    </div>
                    <button class="btn btn-primary w-100" id="validateBtn" onclick="validatePublications()">
                        <i class="fas fa-check-circle"></i> Validate Claims
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-clipboard-check"></i> Validation Results
                </div>
                <div class="card-body" id="resultsPanel" style="max-height: 600px; overflow-y: auto;">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-search fa-4x mb-3"></i>
                        <p>Submit claims to see validation results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i> Validation Statistics
                </div>
                <div class="card-body">
                    <div class="row text-center" id="statsPanel">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3 class="text-success" id="supportCount">0</h3>
                                <p class="text-muted">Supported Claims</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3 class="text-danger" id="contradictCount">0</h3>
                                <p class="text-muted">Contradicted Claims</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3 class="text-warning" id="unknownCount">0</h3>
                                <p class="text-muted">Uncertain</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <h3 class="text-info" id="totalCount">0</h3>
                                <p class="text-muted">Total Analyzed</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Citation Verification Panel (Multi-Antibody) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-microscope"></i> Citation Verification (Multi-Antibody System)
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Each citation component (DOI, PMID, Title, Authors, Journal, Year) is verified by its own specialized antibody.
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">DOI:</label>
                                    <input type="text" class="form-control form-control-sm" id="citDoi" placeholder="10.1038/nature12373">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">PMID:</label>
                                    <input type="text" class="form-control form-control-sm" id="citPmid" placeholder="23831764">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Title:</label>
                                    <input type="text" class="form-control form-control-sm" id="citTitle" placeholder="Publication title...">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Authors:</label>
                                    <input type="text" class="form-control form-control-sm" id="citAuthors" placeholder="Smith J, Jones A, ...">
                                </div>
                                <div class="col-8">
                                    <label class="form-label small">Journal:</label>
                                    <input type="text" class="form-control form-control-sm" id="citJournal" placeholder="Nature">
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">Year:</label>
                                    <input type="text" class="form-control form-control-sm" id="citYear" placeholder="2023">
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm w-100 mt-2" onclick="verifyCitation()">
                                <i class="fas fa-vials"></i> Verify Citation Components
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div id="citationVerifyResult" class="p-2 bg-light rounded" style="min-height: 200px;">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-vials fa-2x mb-2"></i>
                                    <p class="small">Enter citation details and click verify</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Activity Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-network-wired"></i> Antigent Activity (Thymus Orchestration)
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="agent-status" id="bcellStatus">
                                <i class="fas fa-user-shield fa-2x text-muted mb-2"></i>
                                <h6>B Cell Antigent</h6>
                                <span class="badge bg-secondary">Ready</span>
                                <small class="d-block mt-1 text-muted">516 patterns</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="agent-status" id="nkcellStatus">
                                <i class="fas fa-shield-virus fa-2x text-muted mb-2"></i>
                                <h6>NK Cell Antigent</h6>
                                <span class="badge bg-secondary">Ready</span>
                                <small class="d-block mt-1 text-muted">25 detectors</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="agent-status" id="dendriticStatus">
                                <i class="fas fa-brain fa-2x text-muted mb-2"></i>
                                <h6>Dendritic Antigent</h6>
                                <span class="badge bg-secondary">Ready</span>
                                <small class="d-block mt-1 text-muted">Feature extraction</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="agent-status" id="orchestratorStatus">
                                <i class="fas fa-project-diagram fa-2x text-muted mb-2"></i>
                                <h6>Thymus Orchestrator</h6>
                                <span class="badge bg-secondary">Ready</span>
                                <small class="d-block mt-1 text-muted">LLM coordination</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hallucination Training Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-graduation-cap"></i> Hallucination Training</span>
                    <span class="badge bg-light text-dark" id="trainingStatusBadge">Status: Checking...</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Training Controls -->
                        <div class="col-md-6">
                            <h6><i class="fas fa-cogs"></i> Training Controls</h6>
                            <p class="text-muted small">Train B Cell antibodies on individual claims (not full citations) to reduce false positives.</p>

                            <div class="mb-3">
                                <label class="form-label">Data Source:</label>
                                <select class="form-select form-select-sm" id="trainingDataSource">
                                    <option value="user_submissions">User Submissions (from database)</option>
                                    <option value="scifact">SciFact (pre-trained on claims)</option>
                                </select>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label small">Max Samples:</label>
                                    <input type="number" class="form-control form-control-sm" id="maxSamples" value="500" min="10" max="10000">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">NK Detectors:</label>
                                    <input type="number" class="form-control form-control-sm" id="nkDetectors" value="100" min="10" max="500">
                                </div>
                            </div>

                            <div class="btn-group w-100 mb-2">
                                <button class="btn btn-info btn-sm" onclick="trainHallucinationModel()">
                                    <i class="fas fa-play"></i> Train Model
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="seedExampleData()">
                                    <i class="fas fa-database"></i> Seed Examples
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="checkTrainingStatus()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>

                            <div id="trainingResult" class="mt-2"></div>
                        </div>

                        <!-- Submit Training Claim -->
                        <div class="col-md-6">
                            <h6><i class="fas fa-plus-circle"></i> Submit Training Claim</h6>
                            <p class="text-muted small">Add individual claims to improve model accuracy. Focus on specific statements, not full citations.</p>

                            <div class="mb-2">
                                <label class="form-label small">Claim Text:</label>
                                <textarea class="form-control form-control-sm" id="trainingClaimInput" rows="2"
                                    placeholder="Enter a single claim, e.g.: 'Aspirin reduces inflammation.'"></textarea>
                            </div>

                            <div class="mb-2">
                                <label class="form-label small">Label:</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="claimLabel" id="labelTruthful" value="truthful" checked>
                                    <label class="btn btn-outline-success btn-sm" for="labelTruthful">
                                        <i class="fas fa-check"></i> Truthful
                                    </label>
                                    <input type="radio" class="btn-check" name="claimLabel" id="labelHallucinated" value="hallucinated">
                                    <label class="btn btn-outline-danger btn-sm" for="labelHallucinated">
                                        <i class="fas fa-times"></i> Hallucinated
                                    </label>
                                </div>
                            </div>

                            <button class="btn btn-success btn-sm w-100" onclick="submitTrainingClaim()">
                                <i class="fas fa-paper-plane"></i> Submit for Training
                            </button>

                            <div id="claimSubmitResult" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let supportCount = 0;
    let contradictCount = 0;
    let unknownCount = 0;
    let totalCount = 0;

    async function validatePublications() {
        const citations = document.getElementById('citationsInput').value;
        const mode = document.getElementById('validationMode').value;
        const resultsPanel = document.getElementById('resultsPanel');
        const validateBtn = document.getElementById('validateBtn');

        if (!citations.trim()) {
            resultsPanel.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Please enter at least one claim to validate
                </div>
            `;
            return;
        }

        // Split by newlines and filter empty lines
        const claims = citations.split('\n')
            .map(c => c.trim())
            .filter(c => c.length > 0);

        // Reset stats
        supportCount = 0;
        contradictCount = 0;
        unknownCount = 0;
        totalCount = claims.length;

        // Show loading state
        validateBtn.disabled = true;
        validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';

        // Update antigent status based on mode
        if (mode === 'quick') {
            updateAgentStatus('bcellStatus', 'analyzing', 'primary');
        } else if (mode === 'standard') {
            updateAgentStatus('bcellStatus', 'analyzing', 'primary');
            updateAgentStatus('nkcellStatus', 'analyzing', 'primary');
        } else if (mode === 'enhanced') {
            updateAgentStatus('bcellStatus', 'analyzing', 'primary');
            updateAgentStatus('nkcellStatus', 'analyzing', 'primary');
            updateAgentStatus('dendriticStatus', 'processing', 'info');
        } else if (mode === 'deep') {
            updateAgentStatus('bcellStatus', 'analyzing', 'primary');
            updateAgentStatus('nkcellStatus', 'analyzing', 'primary');
            updateAgentStatus('dendriticStatus', 'processing', 'info');
            updateAgentStatus('orchestratorStatus', 'coordinating', 'success');
        } else if (mode === 'orchestrated') {
            updateAgentStatus('bcellStatus', 'analyzing', 'primary');
            updateAgentStatus('nkcellStatus', 'analyzing', 'primary');
            updateAgentStatus('dendriticStatus', 'processing', 'info');
            updateAgentStatus('orchestratorStatus', 'orchestrating', 'success');
        }

        resultsPanel.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Validating ${claims.length} claim(s)...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/validate_publications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    claims: claims,
                    mode: mode
                })
            });

            const data = await response.json();

            if (data.success) {
                displayResults(data.results);
            } else {
                resultsPanel.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error: ${data.message}
                    </div>
                `;
            }
        } catch (error) {
            resultsPanel.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> Error: ${error.message}
                </div>
            `;
        } finally {
            validateBtn.disabled = false;
            validateBtn.innerHTML = '<i class="fas fa-check-circle"></i> Validate Claims';
            updateAgentStatus('bcellStatus', 'ready', 'secondary');
            updateAgentStatus('nkcellStatus', 'ready', 'secondary');
            updateAgentStatus('dendriticStatus', 'ready', 'secondary');
            updateAgentStatus('orchestratorStatus', 'ready', 'secondary');
        }
    }

    function displayResults(results) {
        const resultsPanel = document.getElementById('resultsPanel');

        let html = '';
        results.forEach((result, index) => {
            const badge = getVerdictBadge(result.verdict);
            const icon = getVerdictIcon(result.verdict);
            const borderClass = getVerdictBorderClass(result.verdict);

            html += `
                <div class="card mb-3 ${borderClass}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><strong>Claim ${index + 1}</strong></span>
                        ${badge}
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Claim:</strong> ${escapeHtml(result.claim)}</p>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Verdict:</strong> ${icon} ${result.verdict}</p>
                                <p class="mb-1"><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>B Cell Affinity:</strong> ${result.bcell_affinity.toFixed(3)}</p>
                                <p class="mb-1"><strong>NK Anomaly:</strong> ${result.is_anomaly ? 'Yes' : 'No'}</p>
                            </div>
                        </div>
                        ${result.explanation ? `
                            <div class="mt-2 p-2 bg-light rounded">
                                <small><strong>Analysis:</strong> ${escapeHtml(result.explanation)}</small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Update counts
            if (result.verdict === 'SUPPORTS') supportCount++;
            else if (result.verdict === 'CONTRADICTS') contradictCount++;
            else unknownCount++;
        });

        resultsPanel.innerHTML = html;
        updateStats();
    }

    function getVerdictBadge(verdict) {
        const badges = {
            'SUPPORTS': '<span class="badge bg-success">SUPPORTS</span>',
            'CONTRADICTS': '<span class="badge bg-danger">CONTRADICTS</span>',
            'NOT ENOUGH INFO': '<span class="badge bg-warning text-dark">NOT ENOUGH INFO</span>',
            'UNCERTAIN': '<span class="badge bg-secondary">UNCERTAIN</span>'
        };
        return badges[verdict] || '<span class="badge bg-secondary">UNKNOWN</span>';
    }

    function getVerdictIcon(verdict) {
        const icons = {
            'SUPPORTS': '<i class="fas fa-check-circle text-success"></i>',
            'CONTRADICTS': '<i class="fas fa-times-circle text-danger"></i>',
            'NOT ENOUGH INFO': '<i class="fas fa-question-circle text-warning"></i>',
            'UNCERTAIN': '<i class="fas fa-exclamation-circle text-secondary"></i>'
        };
        return icons[verdict] || '<i class="fas fa-question"></i>';
    }

    function getVerdictBorderClass(verdict) {
        const classes = {
            'SUPPORTS': 'border-success',
            'CONTRADICTS': 'border-danger',
            'NOT ENOUGH INFO': 'border-warning',
            'UNCERTAIN': 'border-secondary'
        };
        return classes[verdict] || 'border-secondary';
    }

    function updateStats() {
        document.getElementById('supportCount').textContent = supportCount;
        document.getElementById('contradictCount').textContent = contradictCount;
        document.getElementById('unknownCount').textContent = unknownCount;
        document.getElementById('totalCount').textContent = totalCount;
    }

    function updateAgentStatus(agentId, status, badgeClass) {
        const statusMap = {
            'analyzing': 'Analyzing',
            'searching': 'Searching',
            'processing': 'Processing',
            'coordinating': 'Coordinating',
            'orchestrating': 'Orchestrating',
            'ready': 'Ready',
            'idle': 'Idle'
        };
        const agent = document.getElementById(agentId);
        const badge = agent.querySelector('.badge');
        badge.className = `badge bg-${badgeClass}`;
        badge.textContent = statusMap[status] || status;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========================================
    // Citation Verification (Multi-Antibody)
    // ========================================

    async function verifyCitation() {
        const resultDiv = document.getElementById('citationVerifyResult');

        const citation = {
            doi: document.getElementById('citDoi').value.trim(),
            pmid: document.getElementById('citPmid').value.trim(),
            title: document.getElementById('citTitle').value.trim(),
            authors: document.getElementById('citAuthors').value.trim(),
            journal: document.getElementById('citJournal').value.trim(),
            year: document.getElementById('citYear').value.trim()
        };

        // Check if at least one field has content
        const hasContent = Object.values(citation).some(v => v.length > 0);
        if (!hasContent) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning py-2 small">
                    <i class="fas fa-exclamation-triangle"></i> Enter at least one citation field
                </div>
            `;
            return;
        }

        resultDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-secondary"></div>
                <p class="small mt-2">Verifying with antibodies...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/verify_citation_components', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ citation: citation })
            });

            const data = await response.json();

            if (data.success) {
                const verdictClass = data.is_hallucinated ? 'danger' : 'success';
                const verdictIcon = data.is_hallucinated ? 'times-circle' : 'check-circle';
                const verdictText = data.is_hallucinated ? 'LIKELY HALLUCINATED' : 'APPEARS VALID';

                let componentsHtml = '';
                for (const [comp, details] of Object.entries(data.components || {})) {
                    const icon = details.is_anomaly ? '‚ùå' : '‚úÖ';
                    const bgClass = details.is_anomaly ? 'bg-danger-subtle' : 'bg-success-subtle';
                    componentsHtml += `
                        <div class="d-flex justify-content-between align-items-center py-1 px-2 mb-1 rounded ${bgClass}">
                            <span class="small fw-bold">${icon} ${comp.toUpperCase()}</span>
                            <span class="small text-muted" style="font-size: 0.7rem;">${details.reason.substring(0, 30)}${details.reason.length > 30 ? '...' : ''}</span>
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    <div class="text-center mb-2">
                        <span class="badge bg-${verdictClass} fs-6">
                            <i class="fas fa-${verdictIcon}"></i> ${verdictText}
                        </span>
                        <div class="small text-muted mt-1">
                            Confidence: ${(data.overall_confidence * 100).toFixed(0)}% |
                            Anomalies: ${data.anomaly_count}/${data.total_checks}
                        </div>
                    </div>
                    <div class="mt-2">
                        ${componentsHtml}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger py-2 small">
                        <i class="fas fa-times"></i> ${data.message}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger py-2 small">
                    <i class="fas fa-times"></i> Error: ${error.message}
                </div>
            `;
        }
    }

    // ========================================
    // Hallucination Training Functions
    // ========================================

    async function checkTrainingStatus() {
        const badge = document.getElementById('trainingStatusBadge');
        try {
            const response = await fetch('/api/hallucination_training_status');
            const data = await response.json();

            let statusText = data.status || 'unknown';
            let badgeClass = 'bg-secondary';

            if (statusText === 'idle') {
                badgeClass = 'bg-secondary';
                statusText = 'Ready';
            } else if (statusText === 'in_progress') {
                badgeClass = 'bg-warning text-dark';
                statusText = 'Training...';
            } else if (statusText === 'completed') {
                badgeClass = 'bg-success';
                statusText = 'Trained';
            } else if (statusText === 'error') {
                badgeClass = 'bg-danger';
                statusText = 'Error';
            }

            badge.className = `badge ${badgeClass}`;
            badge.textContent = `Status: ${statusText}`;
        } catch (error) {
            badge.className = 'badge bg-danger';
            badge.textContent = 'Status: Error';
        }
    }

    async function trainHallucinationModel() {
        const dataSource = document.getElementById('trainingDataSource').value;
        const maxSamples = parseInt(document.getElementById('maxSamples').value);
        const nkDetectors = parseInt(document.getElementById('nkDetectors').value);
        const resultDiv = document.getElementById('trainingResult');

        resultDiv.innerHTML = `
            <div class="alert alert-info py-2">
                <i class="fas fa-spinner fa-spin"></i> Training in progress...
            </div>
        `;

        try {
            const response = await fetch('/api/train_hallucination', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data_source: dataSource,
                    max_samples: maxSamples,
                    nk_detectors: nkDetectors,
                    use_claims_only: true
                })
            });

            const data = await response.json();

            if (data.success) {
                let statsHtml = '';
                if (data.stats) {
                    statsHtml = `<small class="d-block mt-1">`;
                    if (data.stats.truthful_samples !== undefined) {
                        statsHtml += `Truthful: ${data.stats.truthful_samples}, Hallucinated: ${data.stats.hallucinated_samples}`;
                    }
                    if (data.stats.bcell_patterns !== undefined) {
                        statsHtml += ` | B Cell patterns: ${data.stats.bcell_patterns}`;
                    }
                    statsHtml += `</small>`;
                }
                resultDiv.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check"></i> ${data.message}
                        ${statsHtml}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="fas fa-times"></i> ${data.message}
                    </div>
                `;
            }

            checkTrainingStatus();
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="fas fa-times"></i> Error: ${error.message}
                </div>
            `;
        }
    }

    async function seedExampleData() {
        const resultDiv = document.getElementById('trainingResult');

        resultDiv.innerHTML = `
            <div class="alert alert-info py-2">
                <i class="fas fa-spinner fa-spin"></i> Seeding example data...
            </div>
        `;

        try {
            const response = await fetch('/api/seed_hallucination_examples', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check"></i> ${data.message}
                        <small class="d-block">Truthful: ${data.truthful_count}, Hallucinated: ${data.hallucinated_count}</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="fas fa-times"></i> ${data.message}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="fas fa-times"></i> Error: ${error.message}
                </div>
            `;
        }
    }

    async function submitTrainingClaim() {
        const claim = document.getElementById('trainingClaimInput').value.trim();
        const label = document.querySelector('input[name="claimLabel"]:checked').value;
        const resultDiv = document.getElementById('claimSubmitResult');

        if (!claim) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning py-1 small">
                    <i class="fas fa-exclamation-triangle"></i> Please enter a claim
                </div>
            `;
            return;
        }

        try {
            const response = await fetch('/api/submit_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    domain: 'hallucination',
                    label: label,
                    data: claim
                })
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success py-1 small">
                        <i class="fas fa-check"></i> Claim submitted (ID: ${data.submission_id})
                    </div>
                `;
                document.getElementById('trainingClaimInput').value = '';
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger py-1 small">
                        <i class="fas fa-times"></i> ${data.message}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger py-1 small">
                    <i class="fas fa-times"></i> Error: ${error.message}
                </div>
            `;
        }
    }

    // Check training status on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkTrainingStatus();
    });
</script>
{% endblock %}
