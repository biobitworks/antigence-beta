{% extends "base.html" %}

{% block title %}Network Intrusion Detection - IMMUNOS-MCP{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="container mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active">Network Intrusion Detection</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-network-wired text-warning"></i> Network Intrusion Detection</h1>
            <p class="lead">Detect network attacks using NK Cell negative selection and anomaly detection</p>
        </div>
    </div>

    <div class="row">
        <!-- Input Panel -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-server"></i> Network Traffic Input
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Traffic Type:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="trafficType" id="typeNormal" value="normal" checked>
                            <label class="btn btn-outline-success" for="typeNormal">Normal</label>

                            <input type="radio" class="btn-check" name="trafficType" id="typeDoS" value="dos">
                            <label class="btn btn-outline-danger" for="typeDoS">DoS</label>

                            <input type="radio" class="btn-check" name="trafficType" id="typeProbe" value="probe">
                            <label class="btn btn-outline-warning" for="typeProbe">Probe</label>

                            <input type="radio" class="btn-check" name="trafficType" id="typeR2L" value="r2l">
                            <label class="btn btn-outline-info" for="typeR2L">R2L</label>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="srcIP" class="form-label">Source IP:</label>
                            <input type="text" class="form-control" id="srcIP" value="192.168.1.100">
                        </div>
                        <div class="col-6">
                            <label for="dstIP" class="form-label">Destination IP:</label>
                            <input type="text" class="form-control" id="dstIP" value="10.0.0.1">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="srcPort" class="form-label">Source Port:</label>
                            <input type="number" class="form-control" id="srcPort" value="54321">
                        </div>
                        <div class="col-6">
                            <label for="dstPort" class="form-label">Destination Port:</label>
                            <input type="number" class="form-control" id="dstPort" value="80">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-4">
                            <label for="protocol" class="form-label">Protocol:</label>
                            <select class="form-select" id="protocol">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="icmp">ICMP</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="packetSize" class="form-label">Packet Size:</label>
                            <input type="number" class="form-control" id="packetSize" value="1024">
                        </div>
                        <div class="col-4">
                            <label for="packetCount" class="form-label">Packet Count:</label>
                            <input type="number" class="form-control" id="packetCount" value="100">
                        </div>
                    </div>

                    <button class="btn btn-warning w-100" id="analyzeBtn" onclick="analyzeTraffic()">
                        <i class="fas fa-shield-alt"></i> Analyze Traffic
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-exclamation-triangle"></i> Detection Results
                </div>
                <div class="card-body" id="resultsPanel">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-satellite-dish fa-4x mb-3"></i>
                        <p>Submit network traffic to analyze</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Anomaly Score Panel -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-tachometer-alt"></i> Anomaly Score
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar bg-success" id="anomalyBar" role="progressbar" style="width: 0%">
                                    <span id="anomalyLabel">0%</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-success">Normal (0-30%)</small>
                                <small class="text-warning">Suspicious (30-70%)</small>
                                <small class="text-danger">Malicious (70-100%)</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <h2 id="anomalyScoreDisplay" class="text-success">0%</h2>
                            <p class="text-muted mb-0">Anomaly Score</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attack Types Reference -->
    <div class="row mt-4">
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-bomb fa-2x text-danger mb-2"></i>
                    <h6>DoS Attack</h6>
                    <small class="text-muted">Denial of Service - overwhelms target with traffic</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-search fa-2x text-warning mb-2"></i>
                    <h6>Probe Attack</h6>
                    <small class="text-muted">Port scanning and network reconnaissance</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-user-secret fa-2x text-info mb-2"></i>
                    <h6>R2L Attack</h6>
                    <small class="text-muted">Remote to Local - unauthorized access attempt</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-user-ninja fa-2x text-secondary mb-2"></i>
                    <h6>U2R Attack</h6>
                    <small class="text-muted">User to Root - privilege escalation</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Traffic Monitor -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-line"></i> Traffic Monitor</span>
                    <span class="badge bg-success" id="monitorStatus">Ready</span>
                </div>
                <div class="card-body">
                    <div id="trafficChart"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize traffic chart
let trafficData = {
    x: [],
    y: [],
    type: 'scatter',
    mode: 'lines',
    name: 'Anomaly Score',
    line: { color: '#ffc107' }
};

Plotly.newPlot('trafficChart', [trafficData], {
    title: 'Real-time Anomaly Detection',
    xaxis: { title: 'Time' },
    yaxis: { title: 'Anomaly Score', range: [0, 1] },
    margin: { t: 40, b: 40, l: 50, r: 20 },
    height: 250
});

async function analyzeTraffic() {
    const trafficType = document.querySelector('input[name="trafficType"]:checked').value;
    const resultsPanel = document.getElementById('resultsPanel');
    const analyzeBtn = document.getElementById('analyzeBtn');

    const trafficData = {
        src_ip: document.getElementById('srcIP').value,
        dst_ip: document.getElementById('dstIP').value,
        src_port: parseInt(document.getElementById('srcPort').value),
        dst_port: parseInt(document.getElementById('dstPort').value),
        protocol: document.getElementById('protocol').value,
        packet_size: parseInt(document.getElementById('packetSize').value),
        packet_count: parseInt(document.getElementById('packetCount').value),
        traffic_type: trafficType
    };

    // Update UI
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    resultsPanel.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">Detecting anomalies...</p></div>';

    try {
        const response = await fetch('/api/analyze_traffic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ traffic_data: trafficData })
        });

        const result = await response.json();
        displayResults(result);
        updateChart(result.anomaly_score);
    } catch (error) {
        resultsPanel.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Analyze Traffic';
    }
}

function displayResults(result) {
    const resultsPanel = document.getElementById('resultsPanel');
    const isAttack = result.classification !== 'normal';
    const alertClass = isAttack ? 'danger' : 'success';
    const icon = isAttack ? 'exclamation-triangle' : 'check-circle';

    let attackInfo = '';
    if (result.attack_type) {
        attackInfo = `<p><strong>Attack Type:</strong> ${result.attack_type.toUpperCase()}</p>`;
    }

    resultsPanel.innerHTML = `
        <div class="alert alert-${alertClass} text-center">
            <i class="fas fa-${icon} fa-3x mb-2"></i>
            <h3>${result.classification.toUpperCase()}</h3>
        </div>
        <div class="mt-3">
            <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
            ${attackInfo}
            <p><strong>Anomaly Score:</strong> ${(result.anomaly_score * 100).toFixed(1)}%</p>
        </div>
    `;

    // Update anomaly bar
    updateAnomalyBar(result.anomaly_score);
}

function updateAnomalyBar(score) {
    const bar = document.getElementById('anomalyBar');
    const label = document.getElementById('anomalyLabel');
    const display = document.getElementById('anomalyScoreDisplay');
    const pct = (score * 100).toFixed(1);

    bar.style.width = pct + '%';
    label.textContent = pct + '%';
    display.textContent = pct + '%';

    // Update color based on score
    bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
    display.classList.remove('text-success', 'text-warning', 'text-danger');

    if (score < 0.3) {
        bar.classList.add('bg-success');
        display.classList.add('text-success');
    } else if (score < 0.7) {
        bar.classList.add('bg-warning');
        display.classList.add('text-warning');
    } else {
        bar.classList.add('bg-danger');
        display.classList.add('text-danger');
    }
}

function updateChart(score) {
    const now = new Date().toLocaleTimeString();

    Plotly.extendTraces('trafficChart', {
        x: [[now]],
        y: [[score]]
    }, [0]);

    // Keep only last 20 points
    if (trafficData.x.length > 20) {
        Plotly.relayout('trafficChart', {
            xaxis: { range: [trafficData.x.length - 20, trafficData.x.length] }
        });
    }
}
</script>
{% endblock %}
